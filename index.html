<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MY DEAR</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Great+Vibes&display=swap" rel="stylesheet">

  <style>
    :root{
      --beige:#f3eadc;
      --beige2:#efe3d2;
      --paper:#ffffff;
      --ink:#1b1b1b;
      --muted:#6b6258;
      --pink:#ff3b7a;
      --shadow: 0 18px 60px rgba(0,0,0,0.18);
      --shadow2: 0 10px 26px rgba(0,0,0,0.14);
      --radius: 22px;
    }

    *{ box-sizing:border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      background: radial-gradient(900px 600px at 50% 15%, var(--beige), var(--beige2));
      overflow:hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--ink);
    }

    .stage{
      height:100%;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      position:relative;
    }

    .hint{
      position:absolute;
      bottom:18px;
      left:0; right:0;
      text-align:center;
      color:var(--muted);
      font-weight:650;
      z-index: 5;
      pointer-events:none;
    }

    /* Envelope */
    .envelopeWrap{
      width:min(360px,92vw);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      z-index: 10;
      transition: transform 240ms ease, opacity 320ms ease;
      touch-action: manipulation;
    }
    .envelopeWrap:active{ transform: scale(0.98); }

    .envelope{
      aspect-ratio:16/11;
      background:rgba(255,255,255,.35);
      border-radius:18px;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }

    .pocket{
      position:absolute; bottom:0; left:0; right:0; height:58%;
      background:rgba(255,255,255,.45);
      clip-path:polygon(0 0,50% 68%,100% 0,100% 100%,0 100%);
      border-top: 1px solid rgba(0,0,0,0.06);
    }

    .flap{
      position:absolute; top:0; left:0; right:0; height:60%;
      background:rgba(255,255,255,.6);
      clip-path:polygon(0 0,50% 82%,100% 0,100% 0,0 0);
      transform-origin:top;
      transform: rotateX(0deg);
      transition: transform .7s cubic-bezier(.2,.9,.2,1);
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }

    .seal{
      position:absolute; top:52%; left:50%;
      transform:translate(-50%,-50%);
      width:54px; height:54px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 30%,#ff78a7,var(--pink));
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      font-weight:900;
      box-shadow: var(--shadow2);
    }

    /* open state */
    .opened .flap{ transform: rotateX(165deg); }

    /* Letter overlay */
    .letterOverlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      opacity:0;
      pointer-events:none;
      transition: opacity 420ms ease;
      z-index: 50;
    }
    .letterOverlay.show{
      opacity:1;
      pointer-events:auto;
    }

    /* paper with texture */
    .paper{
      width:min(520px,94vw);
      height:min(740px,88vh);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      transform: translateY(18px) scale(0.98);
      transition: transform 520ms cubic-bezier(.2,.9,.2,1);
      background:
        repeating-linear-gradient(0deg, transparent 0, transparent 3px, rgba(0,0,0,.012) 4px),
        repeating-linear-gradient(90deg, transparent 0, transparent 7px, rgba(0,0,0,.010) 8px),
        radial-gradient(700px 360px at 20% 18%, rgba(255, 228, 190, 0.45), transparent 55%),
        radial-gradient(600px 320px at 85% 76%, rgba(255, 214, 228, 0.40), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,1));
    }
    .letterOverlay.show .paper{
      transform: translateY(0) scale(1);
    }

    .paperTop{
      padding:18px 18px 12px;
      border-bottom:1px solid rgba(0,0,0,.06);
      background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.55));
      backdrop-filter: blur(2px);
    }
    .toLine{
      font-family:"Playfair Display", serif;
      font-weight:700;
      letter-spacing:0.2px;
    }

    .paperBody{
      padding:18px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      flex:1;
    }
    .hand{
      font-family:"Great Vibes", cursive;
      font-size:2.2rem;
      line-height:1.1;
      margin: 6px 0 10px;
    }
    .text{
      font-family:"Playfair Display", serif;
      font-size:1.05rem;
      line-height:1.75;
      white-space:pre-wrap;
      margin:0;
    }

    /* Type cursor */
    .typeCursor::after{
      content:"";
      display:inline-block;
      width:8px;
      height:1em;
      background:rgba(0,0,0,.25);
      margin-left:6px;
      border-radius:2px;
      animation: blink 900ms infinite;
      vertical-align: -0.15em;
    }
    @keyframes blink{ 50%{ opacity:0; } }

    /* Toast */
    .toast{
      position:fixed;
      bottom:16px;
      left:50%;
      transform:translateX(-50%) translateY(20px);
      width:min(520px,92vw);
      background:rgba(255,255,255,.75);
      padding:12px 14px;
      border-radius:18px;
      box-shadow:var(--shadow2);
      opacity:0;
      pointer-events:none;
      transition:.25s;
      z-index:70;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .toast.show{
      opacity:1;
      pointer-events:auto;
      transform:translateX(-50%) translateY(0);
    }
    .toast b{ font-weight:900; }
    .toast button{
      border:none;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,59,122,0.12);
      color: var(--pink);
      font-weight:900;
      cursor:pointer;
    }

    /* Question */
    .question{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      opacity:0;
      pointer-events:none;
      transition:.35s;
      z-index:80;
    }
    .question.show{ opacity:1; pointer-events:auto; }

    .qCard{
      background:rgba(255,255,255,.75);
      padding:20px;
      border-radius:22px;
      box-shadow:var(--shadow);
      text-align:center;
      width:min(420px,92vw);
      backdrop-filter: blur(10px);
      border:1px solid rgba(0,0,0,0.06);
    }
    .qCard h2{
      margin: 6px 0 8px;
      font-family:"Playfair Display", serif;
      font-weight:800;
      font-size:1.55rem;
    }
    .qCard p{
      margin:0 0 14px;
      color:var(--muted);
      font-weight:650;
    }

    .btnRow{
      position:relative;
      height:160px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      user-select:none;
      touch-action:none;
    }

    .btnPill{
      padding:14px 22px;
      border-radius:999px;
      border:none;
      font-weight:900;
      font-size:1.05rem;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      position:absolute;
      top:0;
      left:50%;
      transform: translateX(-50%);
      user-select:none;
    }
    .yes{
      background:var(--pink);
      color:#fff;
      box-shadow: 0 14px 28px rgba(255,59,122,0.22), 0 16px 40px rgba(0,0,0,0.16);
    }
    .no{
      background:#fff;
      border:1px solid rgba(0,0,0,0.08);
      box-shadow: 0 12px 22px rgba(0,0,0,0.12);
    }

    /* Explosion particles */
    .particle{
      position:fixed;
      width:10px;
      height:10px;
      border-radius:999px;
      background: rgba(255,59,122,0.9);
      pointer-events:none;
      z-index:95;
      animation: pop 520ms ease-out forwards;
      box-shadow: 0 10px 18px rgba(0,0,0,0.12);
    }
    @keyframes pop{
      from{ transform: translate(0,0) scale(1); opacity:1; }
      to{ transform: translate(var(--dx), var(--dy)) scale(0.2); opacity:0; }
    }

    /* Celebration */
    .celebrate{
      position:fixed;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      opacity:0;
      pointer-events:none;
      transition:.35s;
      z-index:100;
      text-align:center;
      padding:18px;
    }
    .celebrate.show{ opacity:1; pointer-events:auto; }

    .bigHeart{
      font-size:120px;
      line-height:1;
      filter: drop-shadow(0 18px 28px rgba(255,59,122,0.20));
      animation: heartPop 900ms cubic-bezier(.2,.9,.2,1) both;
    }
    @keyframes heartPop{
      0%{ transform: scale(0.2); opacity:0; }
      55%{ transform: scale(1.18); opacity:1; }
      100%{ transform: scale(1.0); opacity:1; }
    }
    .loveLine{
      font-family:"Playfair Display", serif;
      font-weight:850;
      font-size:1.6rem;
      margin-top: 6px;
    }
    .loveYou{
      font-family:"Great Vibes", cursive;
      font-size:3rem;
      line-height:1.05;
    }
  </style>
</head>

<body>
  <div class="stage">

    <!-- Envelope -->
    <div class="envelopeWrap" id="envWrap" aria-label="Open letter">
      <div class="envelope" id="envelope">
        <div class="flap"></div>
        <div class="pocket"></div>
        <div class="seal">‚ù§</div>
      </div>
    </div>

    <div class="hint" id="hint">Tap the Envelope</div>

    <!-- Letter -->
    <div class="letterOverlay" id="letterOverlay">
      <div class="paper">
        <div class="paperTop">
          <div class="toLine">To: My dear Layloula</div>
        </div>
        <div class="paperBody" id="paperBody">
          <div class="hand">My love,</div>
          <p class="text typeCursor" id="letterText"></p>
          <div style="height:200px"></div>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
      <div>
        <b>üíå New message</b>
        <div style="font-size:.92rem;color:rgba(0,0,0,.55);font-weight:650;">Tap to open (one question)</div>
      </div>
      <button id="toastBtn">Open</button>
    </div>

    <!-- Question -->
    <div class="question" id="question">
      <div class="qCard">
        <h2>Will you be my Valentine? üíò</h2>
        <p>Try to say no‚Ä¶ if you can</p>
        <div class="btnRow" id="btnRow">
          <button class="btnPill yes" id="yesBtn">YES</button>
          <button class="btnPill no" id="noBtn">NO</button>
        </div>
      </div>
    </div>

    <!-- Celebration -->
    <div class="celebrate" id="celebrate">
      <div class="bigHeart">üíó</div>
      <div class="loveLine">I love</div>
      <div class="loveYou" id="loveYou">youuuuuuu</div>
    </div>

    <!-- Music -->
    <audio id="music" loop>
      <source src="music.mp3" type="audio/mpeg">
    </audio>

  </div>

  <script>
    // ===== Letter content & typing speed =====
    const LETTER_CONTENT = `I wrote this for 2 reasons :
First because I didnt feel like making a powerpoint this time :)
Second because you have truely become a big part in my life.

The distance may seperate us but i always think about you and plan for you.

You will always have my support and i will be proud even if i could have contributed to 1% of your future sucess.
The last times have been turbulent and very insightfull about our capability to pass storms.
I know it will no always be sunshines and rainbows but i know one thing for sure : we will power through them and we will grow from it stronger.

Im flawed ("Yaaah 3aaad 3rftiha hhhhh") but I will always make bad decisions in life but one decision I wont regret is talking to you.
You make things feel lighter.
You make me feel happier
You make me feel LOVED.

And I‚Äôm grateful for you,
for your presence,
your warmth,

So ......`;

    const TYPE_SPEED_MS = 65; // slower = larger number

    // ===== Elements =====
    const envWrap = document.getElementById("envWrap");
    const envelope = document.getElementById("envelope");
    const hint = document.getElementById("hint");

    const letterOverlay = document.getElementById("letterOverlay");
    const paperBody = document.getElementById("paperBody");
    const letterText = document.getElementById("letterText");

    const toast = document.getElementById("toast");
    const toastBtn = document.getElementById("toastBtn");

    const question = document.getElementById("question");
    const btnRow = document.getElementById("btnRow");
    const noBtn = document.getElementById("noBtn");
    const yesBtn = document.getElementById("yesBtn");

    const celebrate = document.getElementById("celebrate");
    const loveYou = document.getElementById("loveYou");

    const music = document.getElementById("music");

    let toastShown = false;
    let questionOpen = false;
    let exploded = false;

    let typingTimer = null;
    let typingDone = false;         // ‚úÖ NEW
    let autoScrollTimer = null;     // ‚úÖ NEW
    let uTimer = null;

    // ===== Auto-scroll helper =====
    function startAutoScroll() {
      stopAutoScroll();
      // Smooth continuous auto-scroll while typing
      autoScrollTimer = setInterval(() => {
        paperBody.scrollTop = paperBody.scrollHeight;
      }, 50);
    }

    function stopAutoScroll() {
      if (autoScrollTimer) {
        clearInterval(autoScrollTimer);
        autoScrollTimer = null;
      }
    }

    // ===== Show toast ONLY when typing is done =====
    function maybeShowToastAfterTyping() {
      if (toastShown || !typingDone) return;

      // Make sure we're at the bottom
      paperBody.scrollTop = paperBody.scrollHeight;

      // Slight delay feels nicer
      setTimeout(() => {
        if (toastShown || !typingDone) return;
        toastShown = true;
        toast.classList.add("show");
      }, 450);
    }

    // ===== Typewriter =====
    function startTyping() {
      if (typingTimer) clearInterval(typingTimer);

      typingDone = false;
      letterText.textContent = "";
      letterText.classList.add("typeCursor");

      // ‚úÖ Start auto-scroll while typing
      startAutoScroll();

      let i = 0;
      typingTimer = setInterval(() => {
        letterText.textContent += LETTER_CONTENT[i] || "";
        i++;

        if (i >= LETTER_CONTENT.length) {
          clearInterval(typingTimer);
          typingTimer = null;

          typingDone = true;
          letterText.classList.remove("typeCursor");

          // ‚úÖ Ensure we land at bottom
          paperBody.scrollTop = paperBody.scrollHeight;

          // ‚úÖ Stop continuous auto-scroll once finished
          stopAutoScroll();

          // ‚úÖ Now allow popup
          maybeShowToastAfterTyping();
        }
      }, TYPE_SPEED_MS);
    }

    // ===== Open letter reliably (mobile-first) =====
    async function openLetter() {
      envelope.classList.add("opened");
      hint.textContent = "";

      // start music safely
      try { await music.play(); } catch(e) {}

      // show letter after flap animation
      setTimeout(() => {
        letterOverlay.classList.add("show");
        startTyping();
      }, 520);

      // fade envelope away so it doesn't interfere
      envWrap.style.pointerEvents = "none";
      envWrap.style.opacity = "0";
      envWrap.style.transform = "translateY(18px) scale(0.98)";
    }

    // Use pointerdown (most reliable) + once
    envWrap.addEventListener("pointerdown", (e) => {
      e.preventDefault();
      openLetter();
    }, { once: true });

    // ‚úÖ Keep scroll listener but block toast until typingDone
    paperBody.addEventListener("scroll", () => {
      if (!typingDone) return; // ‚úÖ toast cannot appear before typing ends
      const max = paperBody.scrollHeight - paperBody.clientHeight;
      if (max <= 0) return;
      const progress = (paperBody.scrollTop / max) * 100;
      if (progress >= 88) {
        maybeShowToastAfterTyping();
      }
    });

    function openQuestion(){
      toast.classList.remove("show");
      question.classList.add("show");
      questionOpen = true;

      // initial NO position
      const row = btnRow.getBoundingClientRect();
      noBtn.style.left = (row.width * 0.65) + "px";
      noBtn.style.top = "0px";
      noBtn.style.transform = "translateX(-50%)";
    }

    toast.addEventListener("pointerdown", (e) => { e.preventDefault(); openQuestion(); });
    toastBtn.addEventListener("pointerdown", (e) => { e.preventDefault(); e.stopPropagation(); openQuestion(); });

    // ===== NO follows pointer near the finger, but avoids click zone =====
    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

    function placeNoNearPointer(clientX, clientY){
      if(!questionOpen || exploded) return;

      const row = btnRow.getBoundingClientRect();
      const nb = noBtn.getBoundingClientRect();

      const px = clientX - row.left;
      const py = clientY - row.top;

      let x = px + 34;
      let y = py + 16;

      const tooClose = Math.abs((x + nb.width/2) - px) < 60 && Math.abs((y + nb.height/2) - py) < 50;
      if(tooClose){
        x = px + (Math.random() > 0.5 ? 95 : -140);
        y = py + (Math.random() > 0.5 ? 75 : -90);
      }

      x = clamp(x, 8, row.width - nb.width - 8);
      y = clamp(y, 0, row.height - nb.height - 2);

      noBtn.style.left = x + "px";
      noBtn.style.top = y + "px";
      noBtn.style.transform = `translateX(0) rotate(${(Math.random()*8 - 4).toFixed(1)}deg)`;
    }

    btnRow.addEventListener("pointermove", (e) => {
      placeNoNearPointer(e.clientX, e.clientY);
    });

    // ===== Explode NO + spawn 3 YES =====
    function explodeAt(x, y){
      for(let i=0;i<22;i++){
        const p = document.createElement("div");
        p.className = "particle";
        const ang = Math.random() * Math.PI * 2;
        const dist = Math.random()*120 + 30;
        p.style.left = x + "px";
        p.style.top = y + "px";
        p.style.setProperty("--dx", Math.cos(ang) * dist + "px");
        p.style.setProperty("--dy", Math.sin(ang) * dist + "px");
        document.body.appendChild(p);
        setTimeout(()=>p.remove(), 650);
      }
    }

    function celebrateNow(){
      question.classList.remove("show");
      celebrate.classList.add("show");

      if(uTimer) clearInterval(uTimer);
      let uCount = 6;
      uTimer = setInterval(() => {
        uCount += 1;
        if(uCount > 140) uCount = 10;
        loveYou.textContent = "you" + "u".repeat(uCount);
      }, 110);
    }

    function spawnYesButtons(){
      const labels = ["YES 1", "YES 2", "YES 3"];
      for(let i=0;i<3;i++){
        const b = document.createElement("button");
        b.className = "btnPill yes";
        b.textContent = labels[i];
        b.style.top = (56 + i*44) + "px";
        b.style.left = (50 + (i===1 ? -16 : (i===2 ? 16 : 0))) + "%";
        b.style.transform = "translateX(-50%)";
        b.addEventListener("pointerdown", (e)=>{ e.preventDefault(); celebrateNow(); });
        btnRow.appendChild(b);
      }
    }

    function explodeNo(e){
      if(exploded) return;
      exploded = true;
      e.preventDefault();

      const r = noBtn.getBoundingClientRect();
      explodeAt(r.left + r.width/2, r.top + r.height/2);

      noBtn.style.opacity = "0";
      noBtn.style.pointerEvents = "none";

      spawnYesButtons();
    }

    noBtn.addEventListener("pointerdown", explodeNo, { passive:false });
    yesBtn.addEventListener("pointerdown", (e)=>{ e.preventDefault(); celebrateNow(); });

  </script>
</body>
</html>
